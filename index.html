<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Auto Face ID</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        body {
            margin: 0; padding: 0;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background-color: #fff; font-family: sans-serif; height: 100vh; overflow: hidden;
        }

        h2 { margin-bottom: 20px; color: #333; text-align: center; transition: color 0.3s; }

        /* DUMALOQ KAMERA */
        .camera-wrapper {
            position: relative;
            width: 280px; height: 280px;
            border-radius: 50%;
            overflow: hidden;
            border: 5px solid #ccc;
            background: #000;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: border-color 0.3s;
        }

        .camera-wrapper.active { border-color: #2ea6ff; } /* Moviy - Jarayon */
        .camera-wrapper.success { border-color: #34c759; } /* Yashil - Tayyor */

        video {
            width: 100%; height: 100%; object-fit: cover;
            transform: scaleX(-1);
        }

        /* Yuborishdan oldin ko'rinadigan rasm */
        #preview-img {
            width: 100%; height: 100%; object-fit: cover;
            display: none;
        }

        /* PROGRESS BAR (Jarayon chizig'i) */
        .progress-bar {
            width: 200px; height: 6px; background: #eee; margin-top: 20px;
            border-radius: 3px; overflow: hidden;
        }
        .progress-fill {
            height: 100%; width: 0%; background: #2ea6ff; transition: width 0.5s;
        }

        #status-text { margin-top: 10px; color: #888; font-size: 14px; }
        canvas { display: none; }
    </style>
</head>
<body>

    <h2 id="task-title">Tizim yuklanmoqda...</h2>

    <div class="camera-wrapper" id="cam-box">
        <video id="video" autoplay playsinline muted></video>
        <img id="preview-img" src="" alt="Captured">
    </div>

    <div class="progress-bar">
        <div class="progress-fill" id="progress"></div>
    </div>
    <div id="status-text">Kamera kutilmoqda...</div>
    <canvas id="canvas"></canvas>

    <script>
        const video = document.getElementById('video');
        const previewImg = document.getElementById('preview-img');
        const title = document.getElementById('task-title');
        const statusTxt = document.getElementById('status-text');
        const camBox = document.getElementById('cam-box');
        const progressFill = document.getElementById('progress');
        const tg = window.Telegram.WebApp;

        tg.expand();

        let isModelLoaded = false;
        let userLocation = null;
        
        // BOSQICHLAR: 0=Kutish, 1=Chapga, 2=O'ngga, 3=To'g'ri, 4=Tugadi
        let currentStep = 0; 
        let holdCounter = 0; // Harakatni ushlab turish vaqti

        // 1. TIZIMNI YUKLASH
        async function init() {
            try {
                // Lokatsiya so'rash (Orqa fonda)
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(p => {
                        userLocation = { lat: p.coords.latitude, long: p.coords.longitude };
                    });
                }

                // AI Model yuklash
                await faceapi.nets.tinyFaceDetector.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models');
                await faceapi.nets.faceLandmark68TinyNet.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models');
                
                startCamera();
            } catch (e) {
                title.innerText = "Xatolik yuz berdi";
            }
        }

        // 2. KAMERA
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "user", width: { ideal: 640 }, height: { ideal: 640 } }, 
                    audio: false 
                });
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    title.innerText = "Kameraga qarang";
                    statusTxt.innerText = "Yuz qidirilmoqda...";
                    currentStep = 1; // Tekshiruvni boshlash
                    detectFrame();
                };
            } catch (e) {
                title.innerText = "Kameraga ruxsat bering";
            }
        }

        // 3. AI MANTIQI (LOOP)
        async function detectFrame() {
            if (currentStep === 4) return; // Tugagan bo'lsa to'xta

            const detection = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks(true);

            if (detection) {
                const landmarks = detection.landmarks;
                const nose = landmarks.getNose()[0]; // Burun uchi
                const leftEye = landmarks.getLeftEye()[0];
                const rightEye = landmarks.getRightEye()[0];
                const jaw = landmarks.getJawOutline();
                
                // Yuzning chap va o'ng qirralari
                const faceLeft = jaw[0].x;
                const faceRight = jaw[16].x;
                const faceWidth = faceRight - faceLeft;

                // Bosh burilishini hisoblash (Nisbiy)
                // Burun yuzning o'rtasidan qanchalik uzoqda?
                const relativeNoseX = (nose.x - faceLeft) / faceWidth;

                // MANTIQ:
                // relativeNoseX ~ 0.5 -> To'g'riga qaragan
                // relativeNoseX < 0.4 -> O'ngga qaragan (oyna effekti bo'lgani uchun teskari bo'lishi mumkin)
                // relativeNoseX > 0.6 -> Chapga qaragan

                processStep(relativeNoseX);
            }

            requestAnimationFrame(detectFrame);
        }

        // 4. BOSQICHLARNI TEKSHIRISH
        function processStep(nosePos) {
            // Oyna rejimi (Mirror) bo'lgani uchun: 
            // Chapga qaraganda burun O'ngga siljiydi (> 0.6)
            // O'ngga qaraganda burun Chapga siljiydi (< 0.4)

            if (currentStep === 1) {
                title.innerText = "‚¨ÖÔ∏è Boshingizni CHAPGA buring";
                title.style.color = "#333";
                camBox.className = "camera-wrapper active";
                
                // Chapga qaradi (0.6 dan katta)
                if (nosePos > 0.65) {
                    holdCounter++;
                    if (holdCounter > 10) { // Biroz ushlab tursa
                        currentStep = 2;
                        holdCounter = 0;
                        progressFill.style.width = "50%";
                    }
                }
            }
            else if (currentStep === 2) {
                title.innerText = "‚û°Ô∏è Endi O'NGGA buring";
                
                // O'ngga qaradi (0.35 dan kichik)
                if (nosePos < 0.35) {
                    holdCounter++;
                    if (holdCounter > 10) {
                        currentStep = 3;
                        holdCounter = 0;
                        progressFill.style.width = "80%";
                    }
                }
            }
            else if (currentStep === 3) {
                title.innerText = "Markazga qarang va kuling üòä";
                
                // To'g'riga qaradi (0.4 va 0.6 orasida)
                if (nosePos > 0.45 && nosePos < 0.55) {
                    holdCounter++;
                    if (holdCounter > 15) { // Barqarorlashguncha kutamiz
                        currentStep = 4;
                        progressFill.style.width = "100%";
                        autoCapture(); // RASMGA OLISH
                    }
                }
            }
        }

        // 5. AVTOMATIK OLISH VA YUBORISH
        function autoCapture() {
            camBox.className = "camera-wrapper success";
            title.innerText = "‚úÖ Ajoyib! Yuborilmoqda...";
            title.style.color = "green";
            statusTxt.innerText = "Avtomatik yuborilmoqda...";

            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            // To'liq rasm olish
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            // Oyna effektini to'g'irlab chizish
            ctx.translate(canvas.width, 0);
            ctx.scale(-1, 1);
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            // Ekranda ko'rsatish (Preview)
            video.style.display = 'none';
            previewImg.src = canvas.toDataURL('image/jpeg');
            previewImg.style.display = 'block';

            // Kichraytirish va Yuborish (300px)
            // Telegramga tez ketishi uchun kichraytiramiz
            const smallCanvas = document.createElement('canvas');
            smallCanvas.width = 300;
            smallCanvas.height = 300;
            const sCtx = smallCanvas.getContext('2d');
            
            // Markazdan qirqib olish (Square Crop)
            const size = Math.min(canvas.width, canvas.height);
            const sx = (canvas.width - size) / 2;
            const sy = (canvas.height - size) / 2;
            
            sCtx.drawImage(canvas, sx, sy, size, size, 0, 0, 300, 300);

            const base64 = smallCanvas.toDataURL('image/jpeg', 0.7);

            // 1.5 sekund rasmni ko'rsatib turib, keyin yuboramiz
            setTimeout(() => {
                if(userLocation) {
                    const data = JSON.stringify({
                        img: base64.split(',')[1],
                        loc: userLocation
                    });
                    tg.sendData(data);
                } else {
                    alert("Lokatsiya topilmadi! GPS yoqing.");
                }
            }, 1500);
        }

        init();
    </script>
</body>
</html>
