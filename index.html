<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fixed Face ID</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script>
        // Xatolikni ushlash
        window.onerror = function(msg, url, line) {
            alert("Xatolik: " + msg + "\nQator: " + line);
        };
    </script>
    <style>
        body { margin: 0; padding: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; background-color: #fff; font-family: sans-serif; height: 100vh; overflow: hidden; }
        h2 { margin-bottom: 15px; color: #333; text-align: center; font-size: 18px; font-weight: bold; }
        .camera-wrapper { position: relative; width: 280px; height: 280px; border-radius: 50%; overflow: hidden; border: 5px solid #ccc; background: #000; transition: border-color 0.3s; z-index: 10; }
        .camera-wrapper.active { border-color: #2ea6ff; }
        .camera-wrapper.success { border-color: #34c759; }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        #preview-img { width: 100%; height: 100%; object-fit: cover; display: none; }
        #status-text { margin-top: 15px; color: #555; font-size: 14px; }
        canvas { display: none; }
    </style>
</head>
<body>

    <h2 id="task-title">Tizim yuklanmoqda...</h2>

    <div class="camera-wrapper" id="cam-box">
        <video id="video" autoplay playsinline muted></video>
        <img id="preview-img" src="" alt="Captured">
    </div>

    <div id="status-text">Kutish...</div>

    <script>
        const video = document.getElementById('video');
        const previewImg = document.getElementById('preview-img');
        const title = document.getElementById('task-title');
        const statusTxt = document.getElementById('status-text');
        const camBox = document.getElementById('cam-box');
        const tg = window.Telegram.WebApp;

        tg.expand();

        let currentStep = 0;
        let userLocation = null;
        let streamObj = null; // Kamera oqimi

        async function init() {
            try {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(p => {
                        userLocation = { lat: p.coords.latitude, long: p.coords.longitude };
                    });
                }
                
                statusTxt.innerText = "Modellar yuklanmoqda...";
                await faceapi.nets.tinyFaceDetector.loadFromUri('https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model');
                
                startCamera();
            } catch (e) {
                alert("Init Error: " + e);
            }
        }

        async function startCamera() {
            try {
                // Avvalgi kamerani o'chirish (Qora ekran yechimi)
                if (streamObj) {
                    streamObj.getTracks().forEach(track => track.stop());
                }

                streamObj = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "user", width: { ideal: 480 }, height: { ideal: 480 } }, 
                    audio: false 
                });
                video.srcObject = streamObj;
                video.onloadedmetadata = () => {
                    video.play();
                    title.innerText = "‚¨ÖÔ∏è Boshingizni CHAPGA buring";
                    camBox.className = "camera-wrapper active";
                    currentStep = 1;
                    setInterval(detectFace, 200);
                };
            } catch (e) {
                alert("Kamera xatosi: " + e.name);
            }
        }

        async function detectFace() {
            if (currentStep === 4) return;
            
            // Try-catch xatolikni ushlash uchun
            try {
                const detection = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions());

                if (detection) {
                    const box = detection.box;
                    // Oddiy mantiq: Yuz o'rtasi
                    const x = box.x + (box.width / 2);
                    const videoW = video.videoWidth;
                    const ratio = x / videoW;

                    // Oyna effekti: Chapga qarasa > 0.6, O'ngga < 0.4
                    if (currentStep === 1 && ratio > 0.6) {
                        currentStep = 2;
                        title.innerText = "‚û°Ô∏è Endi O'NGGA buring";
                    } else if (currentStep === 2 && ratio < 0.4) {
                        currentStep = 3;
                        title.innerText = "üòê To'g'riga qarang";
                    } else if (currentStep === 3 && ratio > 0.4 && ratio < 0.6) {
                        currentStep = 4;
                        captureAndSend();
                    }
                }
            } catch (err) {
                // Xatolik bo'lsa indamaymiz (loop buzilmasligi uchun)
            }
        }

        function captureAndSend() {
            title.innerText = "Yuborilmoqda...";
            title.style.color = "blue";
            camBox.className = "camera-wrapper success";

            const canvas = document.createElement('canvas');
            const size = 150; // JUUUDA KICHIK (4KB uchun)
            canvas.width = size;
            canvas.height = size;
            const ctx = canvas.getContext('2d');

            // Qirqib olish
            const vidSize = Math.min(video.videoWidth, video.videoHeight);
            const sx = (video.videoWidth - vidSize) / 2;
            const sy = (video.videoHeight - vidSize) / 2;
            
            ctx.translate(size, 0);
            ctx.scale(-1, 1);
            ctx.drawImage(video, sx, sy, vidSize, vidSize, 0, 0, size, size);

            // ‚ö†Ô∏è LIMITNI TEKSHIRISH VA SIQISH ‚ö†Ô∏è
            let quality = 0.7;
            let dataUrl = "";
            let jsonString = "";
            
            // Loop orqali o'lchamni kichraytiramiz
            do {
                dataUrl = canvas.toDataURL('image/jpeg', quality);
                const cleanBase64 = dataUrl.split(',')[1];
                
                jsonString = JSON.stringify({
                    img: cleanBase64,
                    loc: userLocation
                });
                
                quality -= 0.1;
            } while (jsonString.length > 4096 && quality > 0.1);

            // Ekranda ko'rsatish
            video.style.display = 'none';
            previewImg.src = dataUrl;
            previewImg.style.display = 'block';

            if (jsonString.length > 4096) {
                alert("Rasm juda katta! Iltimos, qaytadan urining.");
                location.reload(); // Qayta yuklash
                return;
            }

            // Yuborish
            statusTxt.innerText = "Hajm: " + jsonString.length + " bayt. Ketdi!";
            setTimeout(() => {
                tg.sendData(jsonString);
            }, 1000);
        }

        init();
    </script>
</body>
</html>
