<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Active Face ID</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        body {
            margin: 0; padding: 0;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background-color: #fff; font-family: sans-serif; height: 100vh; overflow: hidden;
        }

        h2 { margin-bottom: 15px; color: #333; text-align: center; font-size: 20px; font-weight: bold; }

        /* KAMERA KORPUSI */
        .camera-wrapper {
            position: relative;
            width: 280px; height: 280px;
            border-radius: 50%;
            overflow: hidden;
            border: 5px solid #ccc;
            background: #000;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: border-color 0.3s;
            z-index: 10;
        }

        .camera-wrapper.active { border-color: #2ea6ff; }
        .camera-wrapper.success { border-color: #34c759; }

        video {
            width: 100%; height: 100%; object-fit: cover;
            transform: scaleX(-1);
        }

        #preview-img {
            width: 100%; height: 100%; object-fit: cover; display: none;
        }

        /* PROGRESS */
        .steps-container {
            display: flex; gap: 5px; margin-top: 20px;
        }
        .step-dot {
            width: 15px; height: 15px; border-radius: 50%; background: #eee;
        }
        .step-dot.done { background: #34c759; }
        .step-dot.current { background: #2ea6ff; transform: scale(1.2); }

        #status-text { margin-top: 15px; color: #555; font-size: 14px; font-weight: 500; text-align: center; max-width: 90%;}
        #debug-info { position: absolute; bottom: 5px; font-size: 10px; color: #ccc; }
        
        button {
            font-size: 14px;
            transition: all 0.3s;
        }
        button:hover {
            background: #1e8cd6 !important;
            transform: scale(1.05);
        }
        button:active {
            transform: scale(0.95);
        }
        
        canvas { display: none; }
    </style>
</head>
<body>

    <h2 id="task-title">AI Yuklanmoqda...</h2>

    <div class="camera-wrapper" id="cam-box">
        <video id="video" autoplay playsinline muted></video>
        <img id="preview-img" src="" alt="Captured">
    </div>

    <div class="steps-container">
        <div class="step-dot" id="dot-1"></div>
        <div class="step-dot" id="dot-2"></div>
        <div class="step-dot" id="dot-3"></div>
    </div>

    <div id="status-text">Kutish...</div>
    <div id="debug-info">Init...</div>

    <script>
        const video = document.getElementById('video');
        const previewImg = document.getElementById('preview-img');
        const title = document.getElementById('task-title');
        const statusTxt = document.getElementById('status-text');
        const camBox = document.getElementById('cam-box');
        const debugTxt = document.getElementById('debug-info');
        const tg = window.Telegram.WebApp;

        tg.expand();
        
        // Telegram Web App sozlamalari
        tg.ready();
        tg.enableClosingConfirmation();

        let currentStep = 0; // 0=Yuklash, 1=Chap, 2=O'ng, 3=Markaz
        let userLocation = null;
        let detectionInterval;
        let cameraStream = null;

        // 1. ISHNI BOSHLASH
        async function init() {
            try {
                // Lokatsiya
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(p => {
                        userLocation = { lat: p.coords.latitude, long: p.coords.longitude };
                        console.log("üìç Lokatsiya olingan:", userLocation);
                    }, err => {
                        console.error("‚ùå Lokatsiya xatosi:", err);
                        // Lokatsiya bo'lmasa ham davom etamiz
                        userLocation = null;
                    });
                }

                // AI Model (CDN)
                debugTxt.innerText = "Modellar yuklanmoqda...";
                await faceapi.nets.tinyFaceDetector.loadFromUri('https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model');
                await faceapi.nets.faceLandmark68TinyNet.loadFromUri('https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model');
                
                debugTxt.innerText = "Modellar OK. Kamera...";
                startCamera();
            } catch (e) {
                console.error("‚ùå Init xatosi:", e);
                alert("Xato: Modellar yuklanmadi. " + e);
            }
        }

        // 2. KAMERA
        async function startCamera(retryCount = 0) {
            const maxRetries = 3;
            
            try {
                // Avval eski streamni to'xtatamiz (agar bo'lsa)
                if (video.srcObject) {
                    const tracks = video.srcObject.getTracks();
                    tracks.forEach(track => track.stop());
                    video.srcObject = null;
                }
                
                // Kamera parametrlarini moslashtirish
                let constraints = {
                    video: {
                        facingMode: "user",
                        // Ideal o'lchamlar o'rniga moslashuvchan parametrlar
                        width: { min: 320, ideal: 640, max: 1280 },
                        height: { min: 240, ideal: 480, max: 720 }
                    },
                    audio: false
                };
                
                // Agar ideal o'lchamlar ishlamasa, oddiy parametrlar bilan urinib ko'ramiz
                if (retryCount > 0) {
                    constraints.video = { facingMode: "user" };
                }
                
                debugTxt.innerText = `Kamera ochilmoqda... (${retryCount + 1}/${maxRetries + 1})`;
                
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                cameraStream = stream; // Streamni saqlash
                video.srcObject = stream;
                
                video.onloadedmetadata = () => {
                    video.play().then(() => {
                        debugTxt.innerText = "Kamera tayyor!";
                        title.innerText = "‚¨ÖÔ∏è Boshingizni CHAPGA buring";
                        updateDots(1);
                        currentStep = 1; 
                        camBox.classList.add('active');
                        
                        // Tekshiruvni boshlash
                        detectionInterval = setInterval(detectFace, 200);
                    }).catch(err => {
                        console.error("‚ùå Video play xatosi:", err);
                        showCameraError("Video o'ynatib bo'lmadi");
                    });
                };
                
                video.onerror = (err) => {
                    console.error("‚ùå Video element xatosi:", err);
                    showCameraError("Video xatosi");
                };
                
            } catch (e) {
                console.error("‚ùå Kamera xatosi:", e);
                
                let errorMessage = "Kamera xatosi";
                
                if (e.name === "NotReadableError") {
                    errorMessage = "Kamera boshqa dastur tomonidan ishlatilmoqda. Barcha dasturlarni yoping va qayta urinib ko'ring.";
                } else if (e.name === "NotFoundError") {
                    errorMessage = "Kamera topilmadi. Iltimos, kamerani ulang.";
                } else if (e.name === "NotAllowedError" || e.name === "PermissionDeniedError") {
                    errorMessage = "Kamera ruxsati rad etildi. Sozlamalarda ruxsat bering.";
                } else if (e.name === "OverconstrainedError") {
                    errorMessage = "Kamera parametrlari mos kelmayapti. Qayta urinib ko'ramiz...";
                } else {
                    errorMessage = `Kamera xatosi: ${e.name || e.message}`;
                }
                
                if (retryCount < maxRetries && (e.name === "OverconstrainedError" || e.name === "NotReadableError")) {
                    // Qayta urinish
                    debugTxt.innerText = `Qayta urinilmoqda... (${retryCount + 1}/${maxRetries})`;
                    setTimeout(() => {
                        startCamera(retryCount + 1);
                    }, 1000);
                } else {
                    showCameraError(errorMessage);
                }
            }
        }
        
        function showCameraError(message) {
            title.innerText = "‚ùå Xatolik";
            title.style.color = "red";
            statusTxt.innerText = message;
            debugTxt.innerText = "Kamera ishlamayapti";
            camBox.classList.remove('active');
            
            // Eski tugmani olib tashlash
            const oldBtn = document.querySelector('#retry-camera-btn');
            if (oldBtn) oldBtn.remove();
            
            // Qayta urinish tugmasi
            const retryBtn = document.createElement('button');
            retryBtn.id = 'retry-camera-btn';
            retryBtn.innerText = "üîÑ Qayta urinish";
            retryBtn.style.cssText = "margin-top: 15px; padding: 10px 20px; background: #2ea6ff; color: white; border: none; border-radius: 20px; cursor: pointer; font-size: 14px;";
            retryBtn.onclick = () => {
                retryBtn.remove();
                title.style.color = "#333";
                statusTxt.innerText = "Kutish...";
                debugTxt.innerText = "Qayta urinilmoqda...";
                startCamera(0);
            };
            
            document.body.appendChild(retryBtn);
        }
        
        // Kamera streamini to'xtatish funksiyasi
        function stopCamera() {
            if (cameraStream) {
                const tracks = cameraStream.getTracks();
                tracks.forEach(track => track.stop());
                cameraStream = null;
            }
            if (video.srcObject) {
                video.srcObject = null;
            }
            if (detectionInterval) {
                clearInterval(detectionInterval);
                detectionInterval = null;
            }
        }
        
        // Sahifa yopilganda kamerani to'xtatish
        window.addEventListener('beforeunload', () => {
            stopCamera();
        });

        // 3. AI TEKSHIRUVI
        async function detectFace() {
            if (currentStep === 4) return;

            try {
                // Eng yengil modelni ishlatamiz
                const detection = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks(true);

                if (detection) {
                    const landmarks = detection.landmarks;
                    const nose = landmarks.getNose()[0];
                    const box = detection.detection.box;

                    // Burun joylashuvini hisoblash (0 dan 1 gacha)
                    // 0 = Yuzning chap cheti, 1 = O'ng cheti, 0.5 = O'rtasi
                    const noseRatio = (nose.x - box.x) / box.width;

                    // Debug uchun
                    debugTxt.innerText = `Pos: ${noseRatio.toFixed(2)} | Step: ${currentStep}`;

                    // MANTIQ (Oyna effekti borligini hisobga olib):
                    // Oyna rejimida: Chapga qaraganda burun O'ngga siljiydi (> 0.5)
                    
                    if (currentStep === 1) { // CHAPGA SO'RALDI
                        if (noseRatio > 0.60) { // O'ng tomonga siljish (Oyna effekti)
                            completeStep(1);
                        }
                    } 
                    else if (currentStep === 2) { // O'NGGA SO'RALDI
                        if (noseRatio < 0.40) { // Chap tomonga siljish
                            completeStep(2);
                        }
                    }
                    else if (currentStep === 3) { // MARKAZ
                        if (noseRatio > 0.45 && noseRatio < 0.55) {
                            completeStep(3);
                        }
                    }
                } else {
                    statusTxt.innerText = "Yuz qidirilmoqda...";
                }
            } catch (e) {
                console.error("‚ùå Detection xatosi:", e);
            }
        }

        // 4. QADAMNI YAKUNLASH
        function completeStep(step) {
            if (step === 1) {
                currentStep = 2;
                title.innerText = "‚û°Ô∏è Endi O'NGGA buring";
                updateDots(2);
            } else if (step === 2) {
                currentStep = 3;
                title.innerText = "üôÇ To'g'riga qarab kuling";
                updateDots(3);
            } else if (step === 3) {
                currentStep = 4;
                clearInterval(detectionInterval); // To'xtatish
                captureAndSend();
            }
        }

        function updateDots(step) {
            document.getElementById('dot-1').className = step >= 1 ? "step-dot done" : "step-dot";
            document.getElementById('dot-2').className = step >= 2 ? "step-dot done" : "step-dot";
            document.getElementById('dot-3').className = step >= 3 ? "step-dot done" : "step-dot";
            
            // Currentni belgilash
            document.querySelectorAll('.step-dot').forEach(dot => dot.classList.remove('current'));
            if(step <= 3) document.getElementById(`dot-${step}`).classList.add('current');
        }

        // 5. OLISH VA YUBORISH
        function captureAndSend() {
            title.innerText = "‚úÖ Ajoyib! Yuborilmoqda...";
            title.style.color = "green";
            camBox.className = "camera-wrapper success";
            
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            
            // Oyna effektini to'g'irlash
            ctx.translate(canvas.width, 0);
            ctx.scale(-1, 1);
            ctx.drawImage(video, 0, 0);

            // Ekranda ko'rsatish
            video.style.display = 'none';
            previewImg.src = canvas.toDataURL('image/jpeg');
            previewImg.style.display = 'block';

            // Kichraytirish (Telegram uchun)
            const smallCanvas = document.createElement('canvas');
            const size = 300; 
            smallCanvas.width = size; smallCanvas.height = size;
            const sCtx = smallCanvas.getContext('2d');
            
            // Markazdan qirqish
            const minSide = Math.min(canvas.width, canvas.height);
            const sx = (canvas.width - minSide) / 2;
            const sy = (canvas.height - minSide) / 2;
            sCtx.drawImage(canvas, sx, sy, minSide, minSide, 0, 0, size, size);

            const base64 = smallCanvas.toDataURL('image/jpeg', 0.7);
            
            // Base64 dan prefixni olib tashlash
            const base64Data = base64.split(',')[1];

            // Ma'lumotlarni yuborish
            setTimeout(() => {
                const data = {
                    img: base64Data,  // 'img' yoki 'image' - handler ikkalasini ham qo'llab-quvvatlaydi
                    loc: userLocation || { lat: 0, long: 0 }  // 'loc' yoki 'location'
                };
                
                console.log("üì§ Ma'lumot yuborilmoqda...", { 
                    hasImage: !!data.img, 
                    hasLocation: !!data.loc,
                    location: data.loc 
                });
                
                try {
                    tg.sendData(JSON.stringify(data));
                    console.log("‚úÖ Ma'lumot yuborildi!");
                } catch (e) {
                    console.error("‚ùå Yuborish xatosi:", e);
                    alert("Xato: Ma'lumot yuborilmadi. " + e);
                }
            }, 1000);
        }

        init();
    </script>
</body>
</html>
