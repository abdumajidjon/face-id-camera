<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Face ID</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { 
            margin: 0; 
            padding: 20px; 
            font-family: sans-serif; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            background: #f4f4f4; 
            height: 100vh; 
        }
        .screen { 
            display: none; 
            width: 100%; 
            flex-direction: column; 
            align-items: center; 
        }
        .screen.active { 
            display: flex; 
        }
        input { 
            padding: 15px; 
            width: 80%; 
            border-radius: 10px; 
            border: 1px solid #ccc; 
            font-size: 18px; 
            text-align: center; 
            text-transform: uppercase; 
            margin-bottom: 15px; 
        }
        .btn { 
            padding: 15px 50px; 
            background: #2ea6ff; 
            color: white; 
            border: none; 
            border-radius: 30px; 
            font-size: 18px; 
            font-weight: bold; 
            cursor: pointer; 
        }
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .camera-circle { 
            width: 280px; 
            height: 280px; 
            background: black; 
            border-radius: 50%; 
            overflow: hidden; 
            border: 5px solid #fff; 
            position: relative; 
        }
        video { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            transform: scaleX(-1); 
        }
        h2 { 
            color: #333; 
            margin-bottom: 10px; 
        }
        #user-display { 
            font-size: 20px; 
            font-weight: bold; 
            color: #2ea6ff; 
            margin-bottom: 20px; 
        }
        #status {
            margin-top: 15px;
            color: #555;
            font-size: 14px;
        }
        #login-error {
            color: red;
            margin-top: 10px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div id="login-screen" class="screen">
        <h2>Tizimga Kirish</h2>
        <input type="text" id="passport-input" placeholder="Pasport Seriya" maxlength="9">
        <button class="btn" onclick="login()">Kirish</button>
        <p id="login-error"></p>
    </div>

    <div id="camera-screen" class="screen">
        <div id="user-display"></div>
        <div class="camera-circle">
            <video id="video" autoplay playsinline muted></video>
        </div>
        <p id="status">Lokatsiya...</p>
        <button id="capture-btn" class="btn" disabled>Rasmga Olish</button>
    </div>
    <canvas id="canvas" style="display:none;"></canvas>

    <script>
        const tg = window.Telegram.WebApp; 
        tg.expand();
        
        // âš ï¸ MANA SHU YERGA PINGGY LINKINI QO'YING!
        // Eslatma: tunnel har safar qayta ochilganda link o'zgaradi.
        // Biz avtomatik ravishda oxiriga `/api` qo'shamiz.
        const PINGGY_BASE = "https://d16fe16b076d89.lhr.life";
        const SERVER_URL = (PINGGY_BASE || "").replace(/\/+$/, "") + "/api";

        // Mixed content tekshiruvi: GitHub Pages/Telegram WebApp ko'pincha https bo'ladi.
        // https sahifadan http API ga fetch qilish bloklanadi.
        if (window.location.protocol === "https:" && SERVER_URL.startsWith("http://")) {
            const msg = "âŒ Xatolik: Sahifa HTTPS, lekin SERVER_URL HTTP. Pinggy linkni HTTPS qilib qo'ying!";
            console.error(msg, { SERVER_URL, pageProtocol: window.location.protocol });
            document.getElementById("login-error").innerText = msg;
        }

        let userLocation = null; 
        let mediaRecorder; 
        let recordedChunks = [];

        window.onload = () => {
            const savedPassport = localStorage.getItem('u_pass');
            if (savedPassport) {
                login(savedPassport);
            } else {
                document.getElementById('login-screen').classList.add('active');
            }
        };

        async function login(cachedPass = null) {
            const passport = cachedPass || document.getElementById('passport-input').value.toUpperCase().trim();
            if (passport.length < 5) {
                document.getElementById('login-error').innerText = "Pasport seriyasini kiriting!";
                return;
            }
            
            try {
                console.log("ðŸ”¹ Login so'rovi yuborilmoqda:", passport);
                console.log("ðŸ”¹ Server URL:", SERVER_URL);
                
                // CORS preflight'ni oldini olish uchun "simple request" yuboramiz:
                // Content-Type header qo'ymaymiz (brauzer text/plain qilib yuboradi).
                const res = await fetch(`${SERVER_URL}/login`, {
                    method: 'POST',
                    body: JSON.stringify({ passport })
                });
                
                console.log("ðŸ”¹ Server javob status:", res.status);
                
                if (!res.ok) {
                    throw new Error(`Server xatosi: ${res.status} ${res.statusText}`);
                }
                
                const data = await res.json();
                console.log("ðŸ”¹ Server javob:", data);
                
                if (data.status === 'success') {
                    localStorage.setItem('u_pass', passport);
                    localStorage.setItem('u_name', data.name);
                    localStorage.setItem('u_tg', data.tg_id || '');
                    showCamera(data.name);
                } else {
                    document.getElementById('login-error').innerText = data.message || "Pasport topilmadi!";
                    localStorage.clear();
                }
            } catch (e) { 
                const errorMsg = e.message || "Server xatosi! Internetni tekshiring.";
                document.getElementById('login-error').innerText = errorMsg;
                console.error("âŒ Login error:", e);
                console.error("âŒ Error details:", {
                    message: e.message,
                    stack: e.stack,
                    name: e.name
                });
            }
        }

        async function showCamera(name) {
            document.getElementById('login-screen').classList.remove('active');
            document.getElementById('camera-screen').classList.add('active');
            document.getElementById('user-display').innerText = "ðŸ‘¤ " + name;
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'user' }, 
                    audio: false 
                });
                document.getElementById('video').srcObject = stream;
                
                mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
                mediaRecorder.ondataavailable = e => { 
                    if (e.data.size > 0) recordedChunks.push(e.data); 
                };
                
                navigator.geolocation.getCurrentPosition(
                    p => {
                        userLocation = { lat: p.coords.latitude, long: p.coords.longitude };
                        document.getElementById('status').innerText = "âœ… Tayyor";
                        document.getElementById('capture-btn').disabled = false;
                    },
                    err => {
                        document.getElementById('status').innerText = "âŒ GPS yoqing!";
                        alert("Iltimos, GPS (Geolokatsiya) ni yoqing.");
                    },
                    { enableHighAccuracy: true, timeout: 10000 }
                );
            } catch (e) { 
                alert("Kamera xatosi: " + e.message); 
            }
        }

        document.getElementById('capture-btn').addEventListener('click', () => {
            const btn = document.getElementById('capture-btn'); 
            btn.innerText = "Yozilmoqda..."; 
            btn.disabled = true;
            
            recordedChunks = []; 
            mediaRecorder.start();
            
            setTimeout(async () => {
                mediaRecorder.stop();
                
                const video = document.getElementById('video');
                const canvas = document.getElementById('canvas');
                canvas.width = video.videoWidth; 
                canvas.height = video.videoHeight;
                
                const ctx = canvas.getContext('2d'); 
                ctx.translate(canvas.width, 0); 
                ctx.scale(-1, 1); 
                ctx.drawImage(video, 0, 0);
                
                const imgBase64 = canvas.toDataURL('image/jpeg', 0.8).split(',')[1];
                const videoBlob = new Blob(recordedChunks, {type: 'video/webm'});
                const reader = new FileReader(); 
                reader.readAsDataURL(videoBlob);
                
                reader.onloadend = async () => {
                    const vidBase64 = reader.result.split(',')[1];
                    
                    try {
                        // Upload uchun ham preflight bo'lmasin: FormData (multipart/form-data) ishlatamiz
                        const fd = new FormData();
                        fd.append("passport", localStorage.getItem('u_pass'));
                        fd.append("name", localStorage.getItem('u_name'));
                        fd.append("tg_id", localStorage.getItem('u_tg'));
                        fd.append("image", imgBase64);
                        fd.append("video", vidBase64);
                        fd.append("loc", JSON.stringify(userLocation));

                        const res = await fetch(`${SERVER_URL}/upload`, {
                            method: 'POST',
                            body: fd
                        });
                        
                        const data = await res.json();
                        
                        if (data.status === 'success') {
                            document.body.innerHTML = "<h2 style='color:green;text-align:center;margin-top:50px'>âœ… Rahmat!</h2>";
                            setTimeout(() => tg.close(), 2000);
                        } else {
                            alert("Xato: " + (data.message || "Noma'lum xatolik"));
                            btn.disabled = false;
                            btn.innerText = "Rasmga Olish";
                        }
                    } catch (e) { 
                        alert("Internet xatosi: " + e.message); 
                        btn.disabled = false;
                        btn.innerText = "Rasmga Olish";
                    }
                };
            }, 2000);
        });
    </script>
</body>
</html>
