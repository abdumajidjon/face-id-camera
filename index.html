<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart Face ID</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        body {
            margin: 0; padding: 0;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background-color: #ffffff;
            font-family: -apple-system, BlinkMacSystemFont, Roboto, Helvetica, Arial, sans-serif;
            height: 100vh; overflow: hidden;
        }

        /* --- TEPADAGI MATN --- */
        #title-box {
            text-align: center; margin-bottom: 20px;
            height: 40px; display: flex; align-items: center; justify-content: center;
        }
        
        h2 {
            margin: 0; color: #333; font-size: 18px; font-weight: 600;
        }

        .highlight { color: #2481cc; }
        .error { color: #ff3b30; }
        .warning { color: #ffcc00; }

        /* --- DUMALOQ KAMERA --- */
        .camera-wrapper {
            position: relative;
            width: 280px; height: 280px;
            border-radius: 50%;
            overflow: hidden;
            background: #000;
            z-index: 10;
            /* Chegara animatsiyasi */
            border: 5px solid #e5e5e5; 
            transition: border-color 0.3s;
        }

        /* Holatlar uchun ranglar */
        .camera-wrapper.loading { border-color: #e5e5e5; }
        .camera-wrapper.success { border-color: #34c759; } /* Yashil */
        .camera-wrapper.error { border-color: #ff3b30; }   /* Qizil */

        video {
            width: 100%; height: 100%; object-fit: cover;
            transform: scaleX(-1); opacity: 0; /* Yuklanguncha ko'rinmaydi */
            transition: opacity 0.5s;
        }
        
        video.ready { opacity: 1; }

        /* YUZ RAMKASI */
        .face-guide {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 140px; height: 190px;
            border: 2px dashed rgba(255, 255, 255, 0.8);
            border-radius: 50% 50% 40% 40%;
            box-shadow: 0 0 0 100px rgba(0, 0, 0, 0.5); /* Qoraytirish */
            z-index: 20;
        }

        /* --- YUKLASH INDIKATORI (Loader) --- */
        .loader {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 50px; height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #2481cc;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            z-index: 5;
        }

        @keyframes spin { 0% { transform: translate(-50%, -50%) rotate(0deg); } 100% { transform: translate(-50%, -50%) rotate(360deg); } }

        /* --- TUGMA --- */
        #btn-capture {
            margin-top: 25px;
            padding: 14px 50px;
            font-size: 16px;
            background-color: #e5e5e5;
            color: #fff;
            border: none;
            border-radius: 30px;
            cursor: not-allowed;
            font-weight: 600;
            transition: 0.3s;
            width: 80%; max-width: 300px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }

        #btn-capture.active {
            background-color: #2481cc;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(36, 129, 204, 0.3);
            animation: pulse 2s infinite;
        }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }

        canvas { display: none; }
        #version { position: absolute; bottom: 5px; font-size: 10px; color: #ccc; }
    </style>
</head>
<body>

    <div id="title-box">
        <h2 id="status-text">Tizim ishga tushmoqda...</h2>
    </div>

    <div class="camera-wrapper" id="cam-box">
        <div class="loader" id="loader"></div>
        <div class="face-guide"></div>
        <video id="video" autoplay playsinline muted></video>
    </div>

    <button id="btn-capture" disabled>Rasmga Olish</button>
    <div id="version">Smart Face v4.0</div>
    <canvas id="canvas"></canvas>

    <script>
        const video = document.getElementById('video');
        const btn = document.getElementById('btn-capture');
        const statusText = document.getElementById('status-text');
        const camBox = document.getElementById('cam-box');
        const loader = document.getElementById('loader');
        const tg = window.Telegram.WebApp;

        tg.expand();

        let isModelLoaded = false;
        let isFaceValid = false;
        let userLocation = null;

        // --- 1. MODELLARNI YUKLASH (Orqa fonda) ---
        async function initSystem() {
            try {
                // Matn: "Tizim ishga tushmoqda..." (AI haqida gapirmaymiz)
                
                // Modellar yuklanmoqda
                const modelUrl = 'https://justadudewhohacks.github.io/face-api.js/models';
                await faceapi.nets.tinyFaceDetector.loadFromUri(modelUrl);
                
                isModelLoaded = true;
                
                // Kamera yoqish
                statusText.innerText = "Kamera tayyorlanmoqda...";
                startCamera();
            } catch (err) {
                statusText.innerText = "Xatolik: Internet sekin";
                alert("Internetni tekshiring va qayta kiring.");
            }
        }

        // --- 2. KAMERA (Universal) ---
        async function startCamera() {
            try {
                let stream;
                try {
                    stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: "user", width: {ideal:640}, height: {ideal:640} }, 
                        audio: false 
                    });
                } catch (e) {
                    stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
                }
                
                video.srcObject = stream;
                
                video.onloadedmetadata = () => {
                    video.play();
                    video.classList.add('ready'); // Videoni ko'rsatish
                    loader.style.display = 'none'; // Aylanani o'chirish
                    
                    statusText.innerHTML = "Lokatsiya aniqlanmoqda...";
                    getLocation();
                    startFaceDetection();
                };
            } catch (err) {
                statusText.innerText = "❌ Kameraga ruxsat bering!";
                loader.style.display = 'none';
            }
        }

        // --- 3. AI: YUZNI TEKSHIRISH ---
        function startFaceDetection() {
            setInterval(async () => {
                if (!isModelLoaded || !video.srcObject) return;

                // Eng yengil modelni ishlatamiz (tez ishlashi uchun)
                const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions());

                if (detections.length === 0) {
                    updateUI("error", "Yuzingizni RAMKA ichiga joylang");
                    isFaceValid = false;
                } else if (detections.length > 1) {
                    updateUI("warning", "Faqat bir kishi bo'ling!");
                    isFaceValid = false;
                } else {
                    // Yuz o'lchamini tekshirish (Yaqin/Uzoq)
                    const box = detections[0].box;
                    const vWidth = video.videoWidth || 640;

                    if (box.width < vWidth * 0.25) {
                        updateUI("warning", "Kameraga <span class='highlight'>yaqinroq</span> keling");
                        isFaceValid = false;
                    } else {
                        updateUI("success", "✅ Ajoyib! Rasmga tushing");
                        isFaceValid = true;
                    }
                }
                
                checkReadyState();
            }, 300); // Har 300ms da tekshiradi
        }

        function updateUI(state, message) {
            statusText.innerHTML = message;
            
            // Ramka rangini o'zgartirish
            camBox.classList.remove('success', 'error', 'loading');
            if (state === 'success') camBox.classList.add('success');
            if (state === 'error') camBox.classList.add('error');
        }

        function checkReadyState() {
            if (isFaceValid && userLocation) {
                btn.disabled = false;
                btn.classList.add('active');
            } else {
                btn.disabled = true;
                btn.classList.remove('active');
            }
        }

        // --- 4. LOKATSIYA ---
        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (pos) => { userLocation = { lat: pos.coords.latitude, long: pos.coords.longitude }; },
                    (err) => { statusText.innerHTML = "<span class='error'>GPS yoqing!</span>"; }
                );
            }
        }

        // --- 5. YUBORISH (Siqilgan rasm) ---
        btn.addEventListener('click', () => {
            if (!isFaceValid || !userLocation) return;

            btn.innerText = "Yuborilmoqda...";
            btn.disabled = true;

            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Kichraytirish (Tez yuborish uchun)
            const size = Math.min(video.videoWidth, video.videoHeight);
            const outputSize = 300; 

            canvas.width = outputSize;
            canvas.height = outputSize;

            const sx = (video.videoWidth - size) / 2;
            const sy = (video.videoHeight - size) / 2;

            ctx.translate(outputSize, 0);
            ctx.scale(-1, 1);
            ctx.drawImage(video, sx, sy, size, size, 0, 0, outputSize, outputSize);

            const base64 = canvas.toDataURL('image/jpeg', 0.7);

            const data = JSON.stringify({
                image: base64,
                location: userLocation
            });

            tg.sendData(data);
        });

        // Tizimni boshlash
        initSystem();

    </script>
</body>
</html>
